{% extends 'base.html.twig' %}

{% block title %}Hello MainController!
{% endblock %}

{% block body %}


	<div
		class="container  col-3">
		<!--<form class="row g-3" method="POST" action="{{ path('addElt') }}">
					<div class="col-10">
						<input type="text" class="form-control" placeholder="Element" name="elt">
					</div>
					<div class="col-auto">
						<button type="submit" class="btn btn-primary mb-3">add</button>
					</div>
				</form>-->

		<div class="row g-3">
			<div class="col-10">
				<input type="text" class="form-control" placeholder="Element" name="elt" id="input_elt">
			</div>
			<div class="col-auto">
				<button type="submit" class="btn btn-primary mb-3" id="btn_elt">add</button>
			</div>
		</div>

		<table class="table table-striped">
			<thead>
				<tr>
					<th colspan="3">
						<strong>Name</strong>
					</th>
				</tr>
			</thead>
			<tbody id="tbody">
				
			</tbody>
		</table>

		<template id="productrow">
			<tr>
				<td></td>
				<td></td>
				<td></td>
			</tr>
		</template>
	</div>

	<script>

		window.addEventListener("load", function(event) {
			loadTable();
		})

		function buy(i) {
			fetch(window.location.href+"api/"+i.id, {headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
					},
					method: "PUT",
					body: JSON.stringify({"name":i.name})
					})
				.then(response => response.json())
				.then(data => {
					if(data.buy === true){
						document.getElementById('tr-color-' + i.id).className = "table-danger";
						document.getElementById('barre-' + i.id).className = "barre";
					}else{
						document.getElementById('tr-color-' + i.id).classList.remove("table-danger");
						document.getElementById('barre-' + i.id).classList.remove("barre");
					}
				});
			}


			document.getElementById("input_elt").addEventListener('keydown', (event) => {
				if (event.defaultPrevented) {
					return; // Should do nothing if the default action has been cancelled
				}

				if(event.keyCode === "Enter"){
					addEmt(document.getElementById("input_elt").value);
					document.getElementById("input_elt").value = ""
				}
			})

			document.getElementById("btn_elt").addEventListener('click', (event) => {
				if (event.defaultPrevented) {
					return; // Should do nothing if the default action has been cancelled
				}
				addEmt(document.getElementById("input_elt").value);
				document.getElementById("input_elt").value = ""
			})

			function loadTable() {
				fetch(window.location.href+"api")
				.then(res => res.json())
				.then(data => {

					data.forEach(elt =>{
						addTable(elt);
						if(elt.buy === true){
							document.getElementById('tr-color-' + elt.id).className = "table-danger";
							document.getElementById('barre-' + elt.id).className = "barre";
						}
					})

				})
			}

			function addEmt(value){
				fetch(window.location.href+"api",
				{
					headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
					},
					method: "POST",
					body: JSON.stringify({"name":value})
				}).then(res => res.json())
				.then(data => {
					addTable(data);
				});
			}



			function removeElt(id, elt){
				fetch(window.location.href+"api/"+id,
				{
					headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
					},
					method: "DELETE"
				}).then(() =>{
					document.querySelector("tbody").removeChild(elt.parentNode);
				});
			}


			function addTable(elt){
				let tbody = document.querySelector("tbody");
				let template = document.querySelector("#productrow");

				let clone = document.importNode(template.content, true);

				let tr = clone.querySelectorAll("tr");
				tr[0].id = "tr-color-"+elt.id
				let td = clone.querySelectorAll("td");
				td[0].id = "barre-"+elt.id
				td[0].textContent = elt.name;

				let a = document.createElement("a");
				a.className = "btn btn-warning"
				a.addEventListener('click', (event) =>{
					event.stopPropagation();
					buy(elt)
				})
				let i = document.createElement("i");
				i.className = "fas fa-check";
				a.appendChild(i);
				td[1].appendChild(a);

				let ade = document.createElement("a");
				ade.className = "btn btn-danger"
				ade.addEventListener('click', (e)=>{
					e.stopPropagation();
					removeElt(elt.id, td[2]);						
				})
				let ide = document.createElement("i");
				ide.className = "fas fa-trash";
				ade.appendChild(ide);
				td[2].appendChild(ade);

				tbody.appendChild(clone);
			}
	</script>

{% endblock %}
